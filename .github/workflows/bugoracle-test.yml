name: BugOracle Test Runner

on:
  workflow_dispatch:
    inputs:
      test_run_id:
        description: "BugOracle Test Run ID"
        required: true
      test_file:
        description: "Path to test file"
        required: true
        default: "tests/bugoracle-reproduction.spec.ts"

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run BugOracle Test
        id: test
        run: |
          npx playwright test ${{ github.event.inputs.test_file }} --reporter=json > test-results.json 2>&1 || true
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.json
            playwright-report/
            test-results/

      - name: Report result to BugOracle
        if: always()
        env:
          TEST_RUN_ID: ${{ github.event.inputs.test_run_id }}
          STATUS: ${{ steps.test.outcome }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          WEBHOOK_URL: ${{ secrets.BUGORACLE_WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.BUGORACLE_WEBHOOK_SECRET }}
          BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          ERROR_MSG=""
          if [ -f test-results.json ]; then
            # Extract error message safely, escaping for JSON
            ERROR_MSG=$(grep -m1 "Error:" test-results.json 2>/dev/null | head -c 500 || echo "")
          fi
          
          # Build JSON payload using jq to handle escaping properly
          PAYLOAD=$(jq -n \
            --arg test_run_id "$TEST_RUN_ID" \
            --arg status "$STATUS" \
            --arg run_id "$RUN_ID" \
            --arg run_url "$RUN_URL" \
            --arg error_message "$ERROR_MSG" \
            '{test_run_id: $test_run_id, status: $status, run_id: $run_id, run_url: $run_url, error_message: $error_message}')
          
          echo "Sending payload to webhook..."
          curl -X POST "${WEBHOOK_URL}/api/webhooks/github-actions" \
            -H "Content-Type: application/json" \
            -H "x-bugoracle-secret: ${WEBHOOK_SECRET}" \
            -H "x-vercel-protection-bypass: ${BYPASS_SECRET}" \
            -d "$PAYLOAD" || echo "Webhook call failed"

