name: BugOracle Test Runner

on:
  workflow_dispatch:
    inputs:
      test_run_id:
        description: "BugOracle Test Run ID"
        required: true
      test_file:
        description: "Path to test file"
        required: true
        default: "tests/bugoracle-reproduction.spec.ts"

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run BugOracle Test
        id: test
        run: |
          npx playwright test ${{ github.event.inputs.test_file }} --reporter=json > test-results.json 2>&1 || true
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.json
            playwright-report/
            test-results/

      - name: Report result to BugOracle
        if: always()
        run: |
          STATUS="${{ steps.test.outcome }}"
          ERROR_MSG=""
          
          if [ -f test-results.json ]; then
            ERROR_MSG=$(grep -m1 "Error:" test-results.json | head -c 500 || echo "")
          fi
          
          curl -X POST "${{ secrets.BUGORACLE_WEBHOOK_URL }}/api/webhooks/github-actions" \
            -H "Content-Type: application/json" \
            -H "x-bugoracle-secret: ${{ secrets.BUGORACLE_WEBHOOK_SECRET }}" \
            -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" \
            -d "{
              \"test_run_id\": \"${{ github.event.inputs.test_run_id }}\",
              \"status\": \"${STATUS}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"error_message\": \"${ERROR_MSG}\"
            }" || true
